<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COER — Clarity of End Result</title>
  </head>
  <body>
    <header id="toolbar">
      <button id="btn-save" type="button">Save</button>
      <button id="btn-load" type="button">Load</button>
      <button id="btn-print" type="button">Print / Export PDF</button>
      <button id="btn-export-text" type="button">Export Text</button>
    </header>

    <main>
      <form id="coer-form" novalidate>

        <section class="question" id="section-q1">
          <label for="q1-name">Q1 — Initiative name</label>
          <input type="text" id="q1-name" autocomplete="off" />
        </section>

        <section class="question" id="section-q2">
          <label>Q2 — What are the specific results you want to achieve, and by when?</label>
          <ul id="q2-list" class="bullet-list" data-field="specificResults"></ul>
          <button type="button" class="btn-add" data-target="q2-list">+ Add item</button>
        </section>

        <section class="question" id="section-q3">
          <label for="q3-reason">Q3 — Why do you want to achieve it?</label>
          <textarea id="q3-reason" rows="4"></textarea>
        </section>

        <section class="question" id="section-q4">
          <label for="q4-contribution">Q4 — How will it contribute to corporate goals?</label>
          <textarea id="q4-contribution" rows="4"></textarea>
        </section>

        <section class="question" id="section-q5">
          <label>Q5 — What are the consequences?</label>
          <div class="dual-list">
            <div class="dual-list-col">
              <h3>Achieving</h3>
              <ul id="q5a-list" class="bullet-list" data-field="consequencesAchieving"></ul>
              <button type="button" class="btn-add" data-target="q5a-list">+ Add item</button>
            </div>
            <div class="dual-list-col">
              <h3>Not Achieving</h3>
              <ul id="q5b-list" class="bullet-list" data-field="consequencesNotAchieving"></ul>
              <button type="button" class="btn-add" data-target="q5b-list">+ Add item</button>
            </div>
          </div>
        </section>

        <section class="question" id="section-q6">
          <label for="q6-starting-point">Q6 — Where are you now? (starting point)</label>
          <textarea id="q6-starting-point" rows="4"></textarea>
        </section>

        <section class="question" id="section-q7">
          <label>Q7 — Who else needs to be involved?</label>
          <ul id="q7-list" class="bullet-list" data-field="stakeholders"></ul>
          <button type="button" class="btn-add" data-target="q7-list">+ Add item</button>
        </section>

        <section class="question" id="section-q8">
          <label for="q8-confidence">Q8 — How confident are you? (%)</label>
          <input type="text" id="q8-confidence" autocomplete="off" />
        </section>

        <section class="question" id="section-q9">
          <label>Q9 — What obstacles might get in the way?</label>
          <ul id="q9-list" class="bullet-list" data-field="obstacles"></ul>
          <button type="button" class="btn-add" data-target="q9-list">+ Add item</button>
        </section>

      </form>
    </main>

    <!-- Hidden file input used by loadFileFromInput() -->
    <input type="file" id="file-input" accept=".json" style="display:none" aria-hidden="true" />

    <script>
      // ─────────────────────────────────────────────────────────────────────
      // STATE  (T-000.03)
      // ─────────────────────────────────────────────────────────────────────

      // formState holds all 10 COER fields at their defaults.
      // Q1 (initiative name) maps to Initiative.name; all others map to coer.*
      const formState = {
        initiativeName:           "",   // Q1  → Initiative.name
        specificResults:          [],   // Q2  → coer.specificResults
        reason:                   "",   // Q3  → coer.reason
        corporateContribution:    "",   // Q4  → coer.corporateContribution
        consequencesAchieving:    [],   // Q5a → coer.consequencesAchieving
        consequencesNotAchieving: [],   // Q5b → coer.consequencesNotAchieving
        startingPoint:            "",   // Q6  → coer.startingPoint
        stakeholders:             [],   // Q7  → coer.stakeholders
        confidencePercent:        "",   // Q8  → coer.confidencePercent
        obstacles:                []    // Q9  → coer.obstacles
      };

      // Holds the full parsed JSON of the last loaded file so round-trip
      // preservation can write back non-COER fields unchanged (T-002.03).
      let loadedProjectFile = null;

      // ─────────────────────────────────────────────────────────────────────
      // UUID  (T-000.05)
      // ─────────────────────────────────────────────────────────────────────

      // Generate a UUID v4 using crypto.getRandomValues() — works offline and
      // from file:// without any external dependency.
      function generateUUID() {
        const bytes = new Uint8Array(16);
        crypto.getRandomValues(bytes);
        // Set version bits (4) and variant bits (10xx) per RFC 4122.
        bytes[6] = (bytes[6] & 0x0f) | 0x40;  // version 4
        bytes[8] = (bytes[8] & 0x3f) | 0x80;  // variant 10xx
        const hex = Array.from(bytes, function (b) {
          return b.toString(16).padStart(2, "0");
        }).join("");
        return (
          hex.slice(0, 8)  + "-" +
          hex.slice(8, 12) + "-" +
          hex.slice(12, 16) + "-" +
          hex.slice(16, 20) + "-" +
          hex.slice(20)
        );
      }

      // ─────────────────────────────────────────────────────────────────────
      // SERIALIZATION  (T-000.04)
      // ─────────────────────────────────────────────────────────────────────

      // Build the effectivenessToolkit envelope from current formState.
      // If a file was loaded, preserves all non-COER fields (round-trip safe).
      function serializeToProjectFile() {
        const now = new Date().toISOString();

        // Start from loaded initiative (preserves sob, memoryMap, etc.) or
        // create a fresh one with a new UUID.
        const baseInitiative =
          loadedProjectFile &&
          loadedProjectFile.effectivenessToolkit &&
          Array.isArray(loadedProjectFile.effectivenessToolkit.initiatives) &&
          loadedProjectFile.effectivenessToolkit.initiatives[0]
            ? JSON.parse(JSON.stringify(loadedProjectFile.effectivenessToolkit.initiatives[0]))
            : { id: generateUUID() };

        baseInitiative.name = formState.initiativeName;
        baseInitiative.coer = {
          lastModified:             now,
          specificResults:          formState.specificResults.slice(),
          reason:                   formState.reason,
          corporateContribution:    formState.corporateContribution,
          consequencesAchieving:    formState.consequencesAchieving.slice(),
          consequencesNotAchieving: formState.consequencesNotAchieving.slice(),
          startingPoint:            formState.startingPoint,
          stakeholders:             formState.stakeholders.slice(),
          confidencePercent:        formState.confidencePercent,
          obstacles:                formState.obstacles.slice()
        };

        if (loadedProjectFile) {
          const output = JSON.parse(JSON.stringify(loadedProjectFile));
          output.effectivenessToolkit.lastModified      = now;
          output.effectivenessToolkit.initiatives[0]    = baseInitiative;
          return output;
        }

        return {
          effectivenessToolkit: {
            version:      "1.0",
            lastModified: now,
            initiatives:  [baseInitiative]
          }
        };
      }

      // Extract the first initiative's coer section from a parsed JSON object
      // into formState, then store the full file for round-trip preservation.
      function deserializeFromProjectFile(json) {
        const initiative = json.effectivenessToolkit.initiatives[0];
        const coer = initiative.coer || {};

        formState.initiativeName           = initiative.name                       || "";
        formState.specificResults          = (coer.specificResults          || []).slice();
        formState.reason                   =  coer.reason                          || "";
        formState.corporateContribution    =  coer.corporateContribution           || "";
        formState.consequencesAchieving    = (coer.consequencesAchieving    || []).slice();
        formState.consequencesNotAchieving = (coer.consequencesNotAchieving || []).slice();
        formState.startingPoint            =  coer.startingPoint                   || "";
        formState.stakeholders             = (coer.stakeholders             || []).slice();
        formState.confidencePercent        =  coer.confidencePercent               || "";
        formState.obstacles                = (coer.obstacles                || []).slice();

        loadedProjectFile = json;
        return formState;
      }

      // ─────────────────────────────────────────────────────────────────────
      // FILE I/O  (T-000.06)
      // ─────────────────────────────────────────────────────────────────────

      // Trigger a browser file download of `content` (string) as `filename`.
      // Uses Blob + hidden <a download> — works from file:// with no CORS issues.
      function saveFileToDownload(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement("a");
        a.href     = url;
        a.download = filename;
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Open a file picker (JSON files only) and call `callback(fileContentString)`
      // once the user selects a file. Re-uses the hidden #file-input element.
      function loadFileFromInput(callback) {
        const input = document.getElementById("file-input");
        // Remove any previous listener to avoid stacking handlers.
        const handler = function () {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (event) {
            callback(event.target.result);
          };
          reader.readAsText(file);
          // Reset so the same file can be reloaded if needed.
          input.value = "";
          input.removeEventListener("change", handler);
        };
        input.addEventListener("change", handler);
        input.click();
      }

      // ─────────────────────────────────────────────────────────────────────
      // RENDER  (T-000.03)
      // ─────────────────────────────────────────────────────────────────────

      // Escape HTML to prevent XSS when inserting user text into innerHTML.
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // Render a single bullet-list container from an array of strings.
      // Each item gets a Remove button and a text input.
      function renderList(listEl, items) {
        listEl.innerHTML = "";
        items.forEach(function (value, index) {
          const li = document.createElement("li");
          li.className = "list-item";
          li.innerHTML =
            '<input type="text" class="list-item-input" value="' +
            escapeHtml(value) +
            '" data-index="' + index + '" aria-label="Item ' + (index + 1) + '" />' +
            '<button type="button" class="btn-remove" data-index="' + index +
            '" aria-label="Remove item ' + (index + 1) + '">Remove</button>';
          listEl.appendChild(li);
        });
      }

      // Project the full formState into the DOM.
      function renderForm() {
        document.getElementById("q1-name").value         = formState.initiativeName;
        document.getElementById("q3-reason").value       = formState.reason;
        document.getElementById("q4-contribution").value = formState.corporateContribution;
        document.getElementById("q6-starting-point").value = formState.startingPoint;
        document.getElementById("q8-confidence").value   = formState.confidencePercent;

        renderList(document.getElementById("q2-list"),  formState.specificResults);
        renderList(document.getElementById("q5a-list"), formState.consequencesAchieving);
        renderList(document.getElementById("q5b-list"), formState.consequencesNotAchieving);
        renderList(document.getElementById("q7-list"),  formState.stakeholders);
        renderList(document.getElementById("q9-list"),  formState.obstacles);
      }

      // ─────────────────────────────────────────────────────────────────────
      // READ FROM DOM  (T-001.02 / T-001.05)
      // ─────────────────────────────────────────────────────────────────────

      // Collect all text input values from a bullet list container.
      function readListFromDOM(listEl) {
        return Array.from(listEl.querySelectorAll(".list-item-input"))
          .map(function (input) { return input.value; });
      }

      // Read every form field from the DOM back into formState.
      // Called immediately before any save or export operation.
      function readFormStateFromDOM() {
        // Q1 — single-line text (T-001.01)
        formState.initiativeName        = document.getElementById("q1-name").value;
        // Q3, Q4, Q6 — multi-line textareas (T-001.02)
        formState.reason                = document.getElementById("q3-reason").value;
        formState.corporateContribution = document.getElementById("q4-contribution").value;
        formState.startingPoint         = document.getElementById("q6-starting-point").value;
        // Q8 — single-line text stored as string, never coerced (T-001.05)
        formState.confidencePercent     = document.getElementById("q8-confidence").value;
        // Q2, Q5a, Q5b, Q7, Q9 — dynamic bullet lists (T-001.03/04/06)
        formState.specificResults          = readListFromDOM(document.getElementById("q2-list"));
        formState.consequencesAchieving    = readListFromDOM(document.getElementById("q5a-list"));
        formState.consequencesNotAchieving = readListFromDOM(document.getElementById("q5b-list"));
        formState.stakeholders             = readListFromDOM(document.getElementById("q7-list"));
        formState.obstacles                = readListFromDOM(document.getElementById("q9-list"));
      }

      // ─────────────────────────────────────────────────────────────────────
      // LIST EVENT DELEGATION  (T-001.03 / T-001.04 / T-001.06)
      // Handles "+ Add item" and "Remove" for Q2, Q5a, Q5b, Q7, Q9 lists.
      // Single delegated listener on the form — no per-list setup required.
      // ─────────────────────────────────────────────────────────────────────

      document.getElementById("coer-form").addEventListener("click", function (event) {
        var target = event.target;

        // ── "+ Add item" button ──────────────────────────────────────────
        if (target.classList.contains("btn-add")) {
          var listId = target.getAttribute("data-target");
          var listEl = document.getElementById(listId);
          var field  = listEl.getAttribute("data-field");

          // Sync any in-progress typed values before mutating the array.
          formState[field] = readListFromDOM(listEl);
          formState[field].push("");
          renderList(listEl, formState[field]);

          // Move focus to the newly added input.
          var newInputs = listEl.querySelectorAll(".list-item-input");
          if (newInputs.length > 0) {
            newInputs[newInputs.length - 1].focus();
          }
          return;
        }

        // ── "Remove" button ──────────────────────────────────────────────
        if (target.classList.contains("btn-remove")) {
          var li     = target.closest("li");
          var listEl = li.closest("ul");
          var field  = listEl.getAttribute("data-field");
          var index  = parseInt(target.getAttribute("data-index"), 10);

          // Sync current typed values first so we remove the right item.
          var items = readListFromDOM(listEl);
          items.splice(index, 1);
          formState[field] = items;
          renderList(listEl, formState[field]);
          return;
        }
      });

      // ─────────────────────────────────────────────────────────────────────
      // INIT
      // ─────────────────────────────────────────────────────────────────────
      renderForm();
    </script>
  </body>
</html>
